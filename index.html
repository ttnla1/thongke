<!doctype html>
<html lang="vi" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th·ªëng K√™ Thu Chi</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app" class="w-full h-full overflow-auto bg-gradient-to-br from-blue-50 to-indigo-100">
   <div class="max-w-5xl mx-auto p-6"><!-- Header -->
    <div class="text-center mb-8">
     <h1 id="appTitle" class="text-4xl font-bold text-indigo-900 mb-2">Th·ªëng K√™ Thu Chi</h1>
     <p class="text-indigo-600">Qu·∫£n l√Ω v√† t√≠nh to√°n l√£i l·ªó h√†ng ng√†y</p>
    </div><!-- Form nh·∫≠p li·ªáu -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
     <h2 class="text-2xl font-bold text-gray-800 mb-6">üìä Nh·∫≠p D·ªØ Li·ªáu H√¥m Nay</h2>
     <form id="dataForm" class="space-y-6"><!-- Ng√†y -->
      <div><label for="date" class="block text-sm font-semibold text-gray-700 mb-2">üìÖ Ng√†y</label> <input type="date" id="date" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
      </div><!-- T·ªìn h√¥m qua -->
      <div class="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-200">
       <h3 class="text-lg font-bold text-yellow-800 mb-4">üì¶ T·ªìn H√¥m Qua</h3>
       <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div><label for="tonKg" class="block text-sm font-semibold text-gray-700 mb-2">S·ªë kg</label> <input type="number" id="tonKg" step="0.01" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
        </div>
        <div><label for="tonGia" class="block text-sm font-semibold text-gray-700 mb-2">ƒê∆°n gi√° (VNƒê)</label> <input type="number" id="tonGia" step="0.01" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
        </div>
        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Th√†nh ti·ªÅn</label>
         <div id="tonTien" class="w-full px-4 py-3 bg-yellow-100 rounded-lg font-bold text-yellow-800 border-2 border-yellow-300">
          0 VNƒê
         </div>
        </div>
       </div>
      </div><!-- Nh·∫≠p m·ªõi -->
      <div class="bg-green-50 p-4 rounded-lg border-2 border-green-200">
       <h3 class="text-lg font-bold text-green-800 mb-4">üì• Nh·∫≠p M·ªõi</h3>
       <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div><label for="nhapKg" class="block text-sm font-semibold text-gray-700 mb-2">S·ªë kg</label> <input type="number" id="nhapKg" step="0.01" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div><label for="nhapGia" class="block text-sm font-semibold text-gray-700 mb-2">ƒê∆°n gi√° (VNƒê)</label> <input type="number" id="nhapGia" step="0.01" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Th√†nh ti·ªÅn</label>
         <div id="nhapTien" class="w-full px-4 py-3 bg-green-100 rounded-lg font-bold text-green-800 border-2 border-green-300">
          0 VNƒê
         </div>
        </div>
       </div>
      </div><!-- B√°n ra -->
      <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200">
       <h3 class="text-lg font-bold text-blue-800 mb-4">üí∞ B√°n Ra</h3>
       <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div><label for="banKg" class="block text-sm font-semibold text-gray-700 mb-2">S·ªë kg</label> <input type="number" id="banKg" step="0.01" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div><label for="banGia" class="block text-sm font-semibold text-gray-700 mb-2">ƒê∆°n gi√° (VNƒê)</label> <input type="number" id="banGia" step="0.01" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Th√†nh ti·ªÅn</label>
         <div id="banTien" class="w-full px-4 py-3 bg-blue-100 rounded-lg font-bold text-blue-800 border-2 border-blue-300">
          0 VNƒê
         </div>
        </div>
       </div>
      </div><!-- N√∫t submit --> <button type="submit" id="submitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg transition transform hover:scale-105 shadow-lg"> <span id="submitBtnText">üìä T√≠nh To√°n</span> </button>
     </form>
    </div><!-- K·∫øt qu·∫£ t√≠nh to√°n -->
    <div id="resultSection" class="bg-white rounded-2xl shadow-xl p-6 mb-6 hidden">
     <h2 class="text-2xl font-bold text-gray-800 mb-6">üìà K·∫øt Qu·∫£</h2>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-purple-50 p-6 rounded-lg border-2 border-purple-200">
       <h3 class="text-lg font-bold text-purple-800 mb-2">üì¶ T·ªìn Kho C√≤n L·∫°i</h3>
       <p id="conLaiKg" class="text-3xl font-bold text-purple-900">0 kg</p>
      </div>
      <div id="laiLoCard" class="p-6 rounded-lg border-2">
       <h3 class="text-lg font-bold mb-2">üíµ L√£i/L·ªó</h3>
       <p id="laiLo" class="text-3xl font-bold">0 VNƒê</p>
      </div>
     </div>
    </div><!-- L·ªãch s·ª≠ -->
    <div class="bg-white rounded-2xl shadow-xl p-6">
     <h2 class="text-2xl font-bold text-gray-800 mb-6">üìã L·ªãch S·ª≠ Giao D·ªãch</h2>
     <div id="recordsList" class="space-y-4">
      <p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ giao d·ªãch n√†o. H√£y nh·∫≠p d·ªØ li·ªáu ƒë·∫ßu ti√™n!</p>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      app_title: "Th·ªëng K√™ Thu Chi",
      submit_button_text: "T√≠nh to√°n",
      background_color: "#EEF2FF",
      card_color: "#FFFFFF",
      primary_color: "#4F46E5",
      text_color: "#1F2937",
      accent_color: "#818CF8",
      font_family: "system-ui, -apple-system, sans-serif",
      font_size: 16
    };

    let records = [];
    let recordCount = 0;

    // T√≠nh to√°n t·ª± ƒë·ªông
    function updateCalculations() {
      const tonKg = parseFloat(document.getElementById('tonKg').value) || 0;
      const tonGia = parseFloat(document.getElementById('tonGia').value) || 0;
      const nhapKg = parseFloat(document.getElementById('nhapKg').value) || 0;
      const nhapGia = parseFloat(document.getElementById('nhapGia').value) || 0;
      const banKg = parseFloat(document.getElementById('banKg').value) || 0;
      const banGia = parseFloat(document.getElementById('banGia').value) || 0;

      const tonTien = tonKg * tonGia;
      const nhapTien = nhapKg * nhapGia;
      const banTien = banKg * banGia;

      document.getElementById('tonTien').textContent = formatMoney(tonTien);
      document.getElementById('nhapTien').textContent = formatMoney(nhapTien);
      document.getElementById('banTien').textContent = formatMoney(banTien);
    }

    function formatMoney(amount) {
      return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }

    // G·∫Øn s·ª± ki·ªán t√≠nh to√°n t·ª± ƒë·ªông
    ['tonKg', 'tonGia', 'nhapKg', 'nhapGia', 'banKg', 'banGia'].forEach(id => {
      document.getElementById(id).addEventListener('input', updateCalculations);
    });

    // Set ng√†y hi·ªán t·∫°i
    document.getElementById('date').valueAsDate = new Date();

    // X·ª≠ l√Ω form
    document.getElementById('dataForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (recordCount >= 999) {
        showResult('ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 999 giao d·ªãch. Vui l√≤ng x√≥a b·ªõt giao d·ªãch c≈©!', true);
        return;
      }

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span>‚è≥ ƒêang t√≠nh to√°n...</span>';

      const tonKg = parseFloat(document.getElementById('tonKg').value);
      const tonGia = parseFloat(document.getElementById('tonGia').value);
      const nhapKg = parseFloat(document.getElementById('nhapKg').value);
      const nhapGia = parseFloat(document.getElementById('nhapGia').value);
      const banKg = parseFloat(document.getElementById('banKg').value);
      const banGia = parseFloat(document.getElementById('banGia').value);

      const tonTien = tonKg * tonGia;
      const nhapTien = nhapKg * nhapGia;
      const banTien = banKg * banGia;
      const conLaiKg = tonKg + nhapKg - banKg;
      const laiLo = banTien - tonTien - nhapTien;

      const record = {
        id: Date.now().toString(),
        date: document.getElementById('date').value,
        ton_kg: tonKg,
        ton_gia: tonGia,
        ton_tien: tonTien,
        nhap_kg: nhapKg,
        nhap_gia: nhapGia,
        nhap_tien: nhapTien,
        ban_kg: banKg,
        ban_gia: banGia,
        ban_tien: banTien,
        con_lai_kg: conLaiKg,
        lai_lo: laiLo,
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(record);
      
      submitBtn.disabled = false;
      submitBtn.innerHTML = `<span id="submitBtnText">${window.elementSdk?.config?.submit_button_text || defaultConfig.submit_button_text}</span>`;

      if (result.isOk) {
        showResult(conLaiKg, laiLo);
        document.getElementById('dataForm').reset();
        document.getElementById('date').valueAsDate = new Date();
        updateCalculations();
      } else {
        showResult('L·ªói khi l∆∞u d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i!', true);
      }
    });

    function showResult(conLaiKg, laiLo) {
      const resultSection = document.getElementById('resultSection');
      resultSection.classList.remove('hidden');
      
      if (typeof conLaiKg === 'string') {
        document.getElementById('conLaiKg').textContent = conLaiKg;
        return;
      }

      document.getElementById('conLaiKg').textContent = conLaiKg.toFixed(2) + ' kg';
      document.getElementById('laiLo').textContent = formatMoney(laiLo);
      
      const laiLoCard = document.getElementById('laiLoCard');
      if (laiLo < 0) {
        laiLoCard.className = 'p-6 rounded-lg border-2 bg-red-50 border-red-200';
        laiLoCard.querySelector('h3').className = 'text-lg font-bold mb-2 text-red-800';
        laiLoCard.querySelector('h3').textContent = '‚ùå L·ªñ';
        document.getElementById('laiLo').className = 'text-3xl font-bold text-red-900';
      } else {
        laiLoCard.className = 'p-6 rounded-lg border-2 bg-green-50 border-green-200';
        laiLoCard.querySelector('h3').className = 'text-lg font-bold mb-2 text-green-800';
        laiLoCard.querySelector('h3').textContent = '‚úÖ L√ÉI';
        document.getElementById('laiLo').className = 'text-3xl font-bold text-green-900';
      }

      setTimeout(() => {
        resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
    }

    function renderRecords() {
      const container = document.getElementById('recordsList');
      
      if (records.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ giao d·ªãch n√†o. H√£y nh·∫≠p d·ªØ li·ªáu ƒë·∫ßu ti√™n!</p>';
        return;
      }

      const sortedRecords = [...records].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      container.innerHTML = sortedRecords.map(record => `
        <div class="border-2 border-gray-200 rounded-lg p-4 hover:shadow-lg transition">
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="font-bold text-lg text-gray-800">üìÖ ${new Date(record.date).toLocaleDateString('vi-VN')}</h3>
              <p class="text-sm text-gray-500">ID: ${record.id}</p>
            </div>
            <button onclick="deleteRecord('${record.__backendId}')" 
              class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition">
              üóëÔ∏è X√≥a
            </button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="bg-yellow-50 p-3 rounded-lg">
              <p class="text-xs text-gray-600 mb-1">T·ªìn h√¥m qua</p>
              <p class="font-bold text-yellow-800">${record.ton_kg} kg √ó ${formatMoney(record.ton_gia)}</p>
              <p class="text-sm font-semibold text-yellow-900">${formatMoney(record.ton_tien)}</p>
            </div>
            <div class="bg-green-50 p-3 rounded-lg">
              <p class="text-xs text-gray-600 mb-1">Nh·∫≠p m·ªõi</p>
              <p class="font-bold text-green-800">${record.nhap_kg} kg √ó ${formatMoney(record.nhap_gia)}</p>
              <p class="text-sm font-semibold text-green-900">${formatMoney(record.nhap_tien)}</p>
            </div>
            <div class="bg-blue-50 p-3 rounded-lg">
              <p class="text-xs text-gray-600 mb-1">B√°n ra</p>
              <p class="font-bold text-blue-800">${record.ban_kg} kg √ó ${formatMoney(record.ban_gia)}</p>
              <p class="text-sm font-semibold text-blue-900">${formatMoney(record.ban_tien)}</p>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-purple-50 p-3 rounded-lg">
              <p class="text-xs text-gray-600 mb-1">T·ªìn c√≤n l·∫°i</p>
              <p class="text-xl font-bold text-purple-900">${record.con_lai_kg.toFixed(2)} kg</p>
            </div>
            <div class="${record.lai_lo < 0 ? 'bg-red-50' : 'bg-green-50'} p-3 rounded-lg">
              <p class="text-xs text-gray-600 mb-1">${record.lai_lo < 0 ? '‚ùå L·ªó' : '‚úÖ L√£i'}</p>
              <p class="text-xl font-bold ${record.lai_lo < 0 ? 'text-red-900' : 'text-green-900'}">${formatMoney(record.lai_lo)}</p>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function deleteRecord(backendId) {
      const record = records.find(r => r.__backendId === backendId);
      if (!record) return;

      const deleteBtn = event.target;
      deleteBtn.disabled = true;
      deleteBtn.textContent = '‚è≥ ƒêang x√≥a...';

      const result = await window.dataSdk.delete(record);
      
      if (!result.isOk) {
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = 'üóëÔ∏è X√≥a';
        const errorDiv = document.createElement('div');
        errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
        errorDiv.textContent = 'L·ªói khi x√≥a. Vui l√≤ng th·ª≠ l·∫°i!';
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 3000);
      }
    }

    window.deleteRecord = deleteRecord;

    const dataHandler = {
      onDataChanged(data) {
        records = data;
        recordCount = data.length;
        renderRecords();
      }
    };

    async function onConfigChange(config) {
      const appTitle = document.getElementById('appTitle');
      const submitBtnText = document.getElementById('submitBtnText');
      const app = document.getElementById('app');
      
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = 'system-ui, -apple-system, BlinkMacSystemFont, sans-serif';
      const baseSize = config.font_size || defaultConfig.font_size;
      
      appTitle.textContent = config.app_title || defaultConfig.app_title;
      submitBtnText.textContent = config.submit_button_text || defaultConfig.submit_button_text;
      
      appTitle.style.fontFamily = `${customFont}, ${baseFontStack}`;
      appTitle.style.fontSize = `${baseSize * 2}px`;
      
      document.body.style.fontSize = `${baseSize}px`;
      document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;
      
      app.style.background = `linear-gradient(to bottom right, ${config.background_color || defaultConfig.background_color}, ${config.accent_color || defaultConfig.accent_color})`;
      
      document.querySelectorAll('.bg-white').forEach(el => {
        el.style.backgroundColor = config.card_color || defaultConfig.card_color;
      });
      
      document.querySelectorAll('button[type="submit"]').forEach(el => {
        el.style.backgroundColor = config.primary_color || defaultConfig.primary_color;
      });
      
      document.querySelectorAll('h1, h2, h3, p, label').forEach(el => {
        el.style.color = config.text_color || defaultConfig.text_color;
      });
    }

    async function init() {
      const dataResult = await window.dataSdk.init(dataHandler);
      if (!dataResult.isOk) {
        console.error('Failed to initialize data SDK');
      }

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  config.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              },
              {
                get: () => config.card_color || defaultConfig.card_color,
                set: (value) => {
                  config.card_color = value;
                  window.elementSdk.setConfig({ card_color: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.primary_color || defaultConfig.primary_color,
                set: (value) => {
                  config.primary_color = value;
                  window.elementSdk.setConfig({ primary_color: value });
                }
              },
              {
                get: () => config.accent_color || defaultConfig.accent_color,
                set: (value) => {
                  config.accent_color = value;
                  window.elementSdk.setConfig({ accent_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                config.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                config.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ["app_title", config.app_title || defaultConfig.app_title],
            ["submit_button_text", config.submit_button_text || defaultConfig.submit_button_text]
          ])
        });
      }
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b71d8070017c7ba',t:'MTc2NzI2ODY5Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
