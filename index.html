<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Thá»‘ng KÃª Thu Chi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

<div class="max-w-5xl mx-auto p-6">

  <!-- LOGIN -->
  <div id="loginBox" class="text-center mt-20">
    <h1 class="text-3xl font-bold mb-6">ğŸ” ÄÄƒng nháº­p Ä‘á»ƒ sá»­ dá»¥ng</h1>
    <button onclick="login()"
      class="bg-red-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-600">
      ÄÄƒng nháº­p báº±ng Google
    </button>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">

    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-indigo-900">ğŸ“Š Thá»‘ng KÃª Thu Chi</h1>
      <button onclick="logout()" class="text-sm text-red-600 font-bold">
        ÄÄƒng xuáº¥t
      </button>
    </div>

    <!-- FORM -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <form id="dataForm" class="space-y-5">

        <input type="date" id="date" class="w-full border p-2 rounded" required>

        <div class="grid grid-cols-2 gap-3">
          <input id="tonKg" type="number" placeholder="Tá»“n kg" class="border p-2 rounded">
          <input id="tonGia" type="number" placeholder="GiÃ¡ tá»“n" class="border p-2 rounded">
        </div>

        <div class="grid grid-cols-2 gap-3">
          <input id="nhapKg" type="number" placeholder="Nháº­p kg" class="border p-2 rounded">
          <input id="nhapGia" type="number" placeholder="GiÃ¡ nháº­p" class="border p-2 rounded">
        </div>

        <div class="grid grid-cols-2 gap-3">
          <input id="banKg" type="number" placeholder="BÃ¡n kg" class="border p-2 rounded">
          <input id="banGia" type="number" placeholder="GiÃ¡ bÃ¡n" class="border p-2 rounded">
        </div>

        <button class="w-full bg-indigo-600 text-white py-3 rounded font-bold">
          ğŸ’¾ TÃ­nh & LÆ°u
        </button>
      </form>
    </div>

    <!-- HISTORY -->
    <div class="bg-white rounded-xl shadow-lg p-6">
      <div class="flex justify-between mb-3">
        <h2 class="font-bold">ğŸ“‹ Lá»‹ch sá»­</h2>
        <button onclick="clearAll()" class="text-red-500 text-sm">XÃ³a táº¥t cáº£</button>
      </div>
      <div id="history"></div>
    </div>

  </div>
</div>

<script>
/* ================= SUPABASE ================= */
const supabase = supabase.createClient(
  "https://YOUR_PROJECT.supabase.co",
  "YOUR_ANON_KEY"
);

let currentUser = null;

/* ================= AUTH ================= */
async function login() {
  await supabase.auth.signInWithOAuth({ provider: 'google' });
}

async function logout() {
  await supabase.auth.signOut();
  location.reload();
}

supabase.auth.onAuthStateChange((_, session) => {
  if (session) {
    currentUser = session.user;
    document.getElementById('loginBox').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    initDB();
  }
});

/* ================= DB (IndexedDB theo user) ================= */
let db;
let records = [];

function initDB() {
  const req = indexedDB.open("ThuChi_" + currentUser.id, 1);
  req.onupgradeneeded = e => {
    e.target.result.createObjectStore("data", { keyPath: "id" });
  };
  req.onsuccess = e => {
    db = e.target.result;
    loadData();
  };
}

function save(record) {
  const tx = db.transaction("data", "readwrite");
  tx.objectStore("data").put(record);
}

function loadData() {
  const tx = db.transaction("data", "readonly");
  const req = tx.objectStore("data").getAll();
  req.onsuccess = () => {
    records = req.result;
    render();
  };
}

function clearAll() {
  if (!confirm("XÃ³a toÃ n bá»™ dá»¯ liá»‡u?")) return;
  const tx = db.transaction("data", "readwrite");
  tx.objectStore("data").clear();
  records = [];
  render();
}

/* ================= LOGIC ================= */
dataForm.onsubmit = e => {
  e.preventDefault();

  const banKg = +banKgEl.value || 0;
  const banGia = +banGiaEl.value || 0;

  const record = {
    id: Date.now(),
    date: date.value,
    laiLo: banKg * banGia
  };

  records.push(record);
  save(record);
  render();
};

function render() {
  history.innerHTML = records.map(r =>
    `<div class="border p-2 mb-2">${r.date} â€” ${r.laiLo.toLocaleString()} â‚«</div>`
  ).join('');
}

const date = document.getElementById('date');
const banKgEl = document.getElementById('banKg');
const banGiaEl = document.getElementById('banGia');
const history = document.getElementById('history');

date.valueAsDate = new Date();
</script>

</body>
</html>
